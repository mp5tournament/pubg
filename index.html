<html>
<head>
    <link rel="icon" sizes="32x32" href="icon.png">
    <meta charset="utf-8">
    <title>MP5åƒé¸¡è£åˆ¤è¡¨</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: "Microsoft YaHei", sans-serif;
}

body {
    display: flex;
    width: 100vw;
    height: 100vh;
    min-width: 1020px;
    min-height: 600px;
    font-size: 18px;
    line-height: 30px;
}
@media (min-height: 600px) {
    body {
        overflow-y: hidden;
    }
}

/* å·¦ä¾§è¾¹æ  */
#sidebar {
    background: #2c3e50;
    color: white;
    padding: 0;
}
#sidebar>div{
    margin: 10px 10px 10px 5px;
    background-color: white;
    border-radius:10px;
    width: 40px;
    height: 40px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size:34px;
    user-select:none;
    overflow:hidden
}
#sidebar>div:hover{
    filter: drop-shadow(0 0 6px rgba(192, 255, 255, 0.8));
    cursor: pointer;
}
#sidebar>div>span{
    position: relative;
}

#sidebar>div>img{
    width: 100%;
    height: 100%;
}

/* å³ä¾§ä¸»å®¹å™¨ */
.right-container {
    flex: 1;
    gap:1rem;
    margin:1rem;
    display: flex;
    flex-direction: column;
    min-width: 0; /* å…è®¸å®½åº¦å‹ç¼© */
}

/* ä¸»å†…å®¹åŒºå…¬å…±æ ·å¼ */
.split-container {
    flex: 1;
    display: flex;
    min-height: 0;
}

/* åˆ†æ é€šç”¨æ ·å¼ */
.split-panel {
    overflow-y: auto;
    min-width: 0;
}

.main-left {
    flex: 0 0 300px;
    background: #f0f8ff;
}
.main-right {
    display: flex;
    flex: 1;
    background: #f0fff8;
}
#mainConsole{
    background: #fffff0;
    flex: 1;
    padding: 5px;
}
.score-left {
    flex: 0 0 50px;
    background: #ffe4e1;
    display: flex;
    justify-content: center;
    align-items: center;
    padding:0;
}

.vertical-center {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: min-content;
}

.vertical-text {
    writing-mode: vertical-lr;
    text-orientation: upright;
    font-size: 28px;
    font-weight:bold;
    margin: 10px 0;
}

.score-right {
    flex: 1;
    background: #fff8ea;
}

/* é€šç”¨ */
.hidden{
    display: none !important;
}
table{
    font-size:18px;
    line-height: 30px;
    width:100%;
}
td{
    vertical-align:top;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}
span.emoji{
    width:30px;
    display:inline-block;
}
.title{
    font-weight:bold;
}
.cen{
    text-align: center;
}
.rta{
    text-align: right;
}
.mid{
    margin:auto;
}
select{
    width:146px;
    font-size:18px;
    height:30px;
}
button{
    border: 1px solid;
    border-radius: 4px;
    width:100px;
    font-size:18px;
    height:30px;
    user-select: none;
}
button:disabled{
    background-color: #eee !important;
    border: 1px solid #bbb !important;
}
button.small{
    border: 1px solid;
    border-radius: 4px;
    width:20px;
    font-size:10px;
    margin:5px 0;
    height:20px;
}
button.blue{
    background-color: #e0f0ff;
    border: 1px solid #abc;
    color:#008;
}
button.blue:hover{
    background-color: #f0f8ff;
}
button.red{
    background-color: #ffe4e1;
    border: 1px solid #dbb;
    color:#800;
}
button.red:hover{
    background-color: #fff4f0;
}
button.yellow{
    background-color: #ffffd0;
    border: 1px solid #ddb;
    color:#880;
}
button.yellow:hover{
    background-color: #fffff0;
}
textarea {
    resize: none;
    width: 100%;
    height: 73px;
    padding: 0 3px;
    font-size: 18px;
    font-family: inherit;
}
input[type="checkbox"] {
    width: 24px;
    height: 30px;
}
input{
    width:100%;
    font-size:18px;
    height:30px;
    padding:0 3px;
}
select{
    width:100%;
}
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button {
    -webkit-appearance: none !important;
}
.tip-box {
    position: fixed; 
    top: 0;
    bottom: 0;
    font-size: 12px;
    line-height: 12px;
    height: 18px;
    padding: 3px; 
    box-shadow: 1px 1px 3px grey;
    background-color: white; 
    z-index:40;
    display: none;
    user-select: none;
}
@keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
}
.blink {
    animation: blink 0.5s infinite;
}
#cmdTable div{
    padding-left:3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
#cmdTable div:hover{
    cursor: pointer;
    background-color: #fffffa;
}
/* é…ç½® */
#configui { 
    position: fixed; 
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: rgba(0,0,0,0.5);
    z-index:10;
}
#configui .window { 
    position: fixed; 
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    margin:auto;
    width: 469px; 
    height: 245px; 
    padding: 40px 20px; 
    box-shadow: 3px 3px 10px #404040;
    background-color: white; 
    z-index:20;
}
#configui td{
    padding:5px 10px;
}
/* è­¦å‘Šæ‚¬æµ®çª— */
#alertTip {
    opacity: 0;
    visibility: hidden;
    position: fixed;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    white-space: pre;
    background: #ffb;
    top:373px;
    left:60px;
    padding: 5px 8px;
    border-radius: 4px;
    filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.3));
}

#alertTip.active {
    opacity: 1;
    visibility: visible;
}
/* ä¸»æµç¨‹ */
.waiting{
    color:#aaa;
}
.error{
    color:red;
}
.warning{
    color:orange;
}
/* è¡¨æ ¼é¡¹ç›® */
.button{
    width: 30px;
    text-align: center;
}
.rank{
    width: 30px;
    text-align: center;
}
.username{
    width: 140px;
    max-width: 140px;
}
.eliminate{
    color:#aaa;
}
.raw_score input{
    text-align: right;
}
.raw_score{
    width:86px;
}
.score{
    width:80px;
    max-width:80px;
    text-align: right;
}
.mod input, .mod, .award{
    font-family: 'consolas';
}
.points, .round_points{
    width:72px;
    text-align: right;
    padding-right: 15px;
}
.game_points{
    width: 30px;
    text-align: center;
}
</style>
</head>
<body>
<div class="tip-box">å¤åˆ¶æˆåŠŸ</div>

<div id="alertTip"></div>

<div id="configui"><div class="window">
    <table cellspacing="0">
        <tr>
            <td class="rta" style="width:210px;">cache apikey</td><td><input></td>
        </tr>
        <tr>
            <td class="rta" style="width:210px;">osu apikey</td><td><input></td>
        </tr>
        <tr>
            <td class="rta">è®°ä½apikey</td><td><input type="checkbox"></td>
        </tr>
    </table>
    <div style="width:100%;padding: 12px;" class="cen"><button class="blue" onclick="saveConfig()">ç¡®å®š</button></div>
</div></div>

<div id="sidebar">
    <div onclick="location.reload()" title="åˆ·æ–°è£åˆ¤è¡¨"><img src="icon.png"/></div>
    <div><img id="modeLogo"></div>
    <div title="æ‰“å¼€MPLink" onclick="if(MID)window.open(`https://osu.ppy.sh/community/matches/${MID}`)"><span style="top:-1px;">ğŸ </span></div>
    <div title="æ‰“å¼€ç›´æ’­å±•ç¤ºé¡µé¢" onclick="window.open(`live.html?name=${Mode}`)"><span style="top:-1px;">ğŸ“Š</span></div>
    <div title="æ‰“å¼€èµ›å›¾éšæœºæŠ½å–é¡µé¢
ï¼ˆå®é™…æ¯”èµ›ä¸­è¯·ç”±ç›´æ’­å‘˜åœ¨obsè¿›è¡Œæ“ä½œï¼Œè£åˆ¤æ‰“å¼€çš„é¡µé¢å…¶ä»–äººçœ‹ä¸åˆ°ï¼‰" onclick="window.open(`map.html?name=${Mode}`)"><span style="top:-1px;">ğŸ²</span></div>
    <div title="è®¿é—®ä»£ç ä»“åº“" onclick="window.open('https://github.com/mp5tournament/pubg')"><svg height="38" viewBox="0 0 24 24" width="38">
        <path d="M12 1C5.9225 1 1 5.9225 1 12C1 16.8675 4.14875 20.9787 8.52125 22.4362C9.07125 22.5325 9.2775 22.2025 9.2775 21.9137C9.2775 21.6525 9.26375 20.7862 9.26375 19.865C6.5 20.3737 5.785 19.1912 5.565 18.5725C5.44125 18.2562 4.905 17.28 4.4375 17.0187C4.0525 16.8125 3.5025 16.3037 4.42375 16.29C5.29 16.2762 5.90875 17.0875 6.115 17.4175C7.105 19.0812 8.68625 18.6137 9.31875 18.325C9.415 17.61 9.70375 17.1287 10.02 16.8537C7.5725 16.5787 5.015 15.63 5.015 11.4225C5.015 10.2262 5.44125 9.23625 6.1425 8.46625C6.0325 8.19125 5.6475 7.06375 6.2525 5.55125C6.2525 5.55125 7.17375 5.2625 9.2775 6.67875C10.1575 6.43125 11.0925 6.3075 12.0275 6.3075C12.9625 6.3075 13.8975 6.43125 14.7775 6.67875C16.8813 5.24875 17.8025 5.55125 17.8025 5.55125C18.4075 7.06375 18.0225 8.19125 17.9125 8.46625C18.6138 9.23625 19.04 10.2125 19.04 11.4225C19.04 15.6437 16.4688 16.5787 14.0213 16.8537C14.42 17.1975 14.7638 17.8575 14.7638 18.8887C14.7638 20.36 14.75 21.5425 14.75 21.9137C14.75 22.2025 14.9563 22.5462 15.5063 22.4362C19.8513 20.9787 23 16.8537 23 12C23 5.9225 18.0775 1 12 1Z"/>
    </svg></div>
    <div title="é…ç½®API KEY" onclick="configui.classList.remove('hidden')"><span style="top:-1px;">ğŸ—ï¸</span></div>
    <hr style="border-color:#89a;margin:0 8px 0 3px;">
    <div id="alertLogo" class="hidden"><span style="top:-5px;" class="blink">âš ï¸</span></div>
</div>

<div class="right-container">
    <div id="main" class="split-container">
        <div class="split-panel main-left" style="display: flex;flex-direction: column;">
            <div style="padding:5px;font-weight: bold;background-color: #e0e8ff;">
                <span id="stage" style="color:#46c">å‡†å¤‡é˜¶æ®µ</span>
                <button class="yellow" style="float:right" onclick="currentStage.nextStage()">è¿›å…¥ä¸‹é˜¶æ®µ</button>
            </div>
            <div id="cmdTable" style="overflow-y: auto">
                <div onclick="copyText(this)">!MP TIMER 120</div>
            </div>
        </div>
        <div class="split-panel main-right">
            <div class="split-panel" style="flex:2;padding: 5px;max-width: 400px;">
                <div id="mainTableBanner"></div>
                <table id="mainTable">
                </table>
            </div>
            <div class="split-panel" id="mainConsole">
                <div>æ·»åŠ å›¾æ± ä¸é€‰æ‰‹ï¼š<span style="user-select:none" title="æ¯è¡Œä¸€å¼ ï¼ˆåŠå¯¹åº”çš„é€‰æ‰‹ï¼‰ï¼Œè¡Œå†…å…ƒç´ ç”¨\tåŒºåˆ†ï¼ˆ\tä¸ºåˆ¶è¡¨ç¬¦ï¼Œå³ç›´æ¥ä»è¡¨æ ¼å¤åˆ¶å³å¯ï¼‰
æ¯è¡Œæ ¼å¼ä¸ºï¼šé€‰æ‰‹ç”¨æˆ·å \t å›¾bid \t mod
å…¶ä¸­modå¤„å¯ä½¿ç”¨å•ä¸ªæˆ–å¤šä¸ªå•å…ƒæ ¼ï¼Œå³â€œDTHDâ€å’Œâ€œDT \t HDâ€å‡è¡¨ç¤ºDTHDï¼›ç•™ç©ºåˆ™ä¸ºNM
å¯¹äºå›ºå®šå›¾ï¼Œç›´æ¥çœç•¥ç¬¬ä¸€ä¸ªå•å…ƒæ ¼æˆ–ç•™ç©ºå³å¯
å¦‚ï¼š
327526 \t HT \t HD
Guozi on Osu \t 1000684
è¡¨ç¤ºä¸€å¼ MODä¸ºHTHDçš„å›ºå®šå›¾327526å’Œä¸€å¼ MODä¸ºNMçš„é€‰æ‰‹å›¾1000684">â“</span></div>
                <textarea placeholder="å°†é¼ æ ‡ç§»åŠ¨è‡³ä¸Šæ–¹é—®å·ä»¥æŸ¥çœ‹æœ¬åŒºåŸŸè¾“å…¥æ ¼å¼"></textarea>
                <button class="blue" style="margin-top: 5px;" onclick="StageP.add()">æ·»åŠ ä»¥ä¸Š</button>
                <button class="red" style="margin-top: 5px;" onclick="StageP.clear()">æ¸…ç©ºå…¨éƒ¨</button>
                <div>æ¯”èµ›æˆ¿é—´Linkæˆ–IDï¼š</div>
                <input style="width:100%" onchange="StageP.updateMID(this)">
                <div>å·¦ä¾§åˆ—è¡¨ä¸­çš„âœ”ï¸è¡¨ç¤ºè¯¥é€‰æ‰‹å·²ç­¾åˆ°ï¼Œâ³è¡¨ç¤ºè¯¥é€‰æ‰‹æœªç­¾åˆ°ã€‚ç‚¹å‡»ä»¥åˆ‡æ¢è¯¥çŠ¶æ€ã€‚</div>
            </div>
        </div>
    </div>

    <div class="split-container">
        <div class="split-panel score-left">
            <div class="vertical-center">
                <div class="vertical-text">è®°</div>
                <div class="vertical-text">åˆ†</div>
                <div class="vertical-text">ç‰ˆ</div>
            </div>
        </div>
        <div class="split-panel score-right">
            <div style="font-size: 14px;color:#aaa;line-height: 14px;margin:5px;">åœ¨ä¸‹è¡¨å„å•å…ƒæ ¼ä¸Šæ‚¬æµ®å…‰æ ‡ä»¥è·å¾—æ›´å¤šä¿¡æ¯</div>
            <table id="scoreboard" style="width: auto;">
                <tr id="scoreboardHeader" class="persistence"></tr>
            </table>
        </div>
    </div>
</div>

<script type="text/javascript">
function asserts(x){
    if(!x)throw ''
}
// å¤åˆ¶å‘½ä»¤
{
    const mouse={x:0,y:0}
    const box0=document.querySelector('.tip-box')
    document.addEventListener('click', function(event){
        mouse.x = event.clientX
        mouse.y = event.clientY
    })
    function copyText(x,y=null){
        const input = document.createElement('textarea')
        document.body.appendChild(input)
        input.innerHTML = y || x.title || x.textContent
        input.select()
        document.execCommand('Copy')
        document.body.removeChild(input)

        setTimeout(function(){
            const box = box0.cloneNode(true)
            document.body.appendChild(box)
            box.style.left = mouse.x + 'px'
            box.style.top = mouse.y + 'px'
            box.style.display = 'block'
            box.style.opacity = 1
            setTimeout(function(){
                box.style.opacity = 0.75
                setTimeout(function(){
                    box.style.opacity = 0.5
                },40)
                setTimeout(function(){
                    box.style.opacity = 0.25
                },80)
                setTimeout(function(){
                    box.style.opacity = 0
                    document.body.removeChild(box)
                },120)
            },500)
        },10)
    }
}
// æ¸…ç†èµ„æº
function clearElement(element) {
    while (element.lastChild) {
        const child = element.lastChild
        if (child instanceof HTMLElement && !child.classList.contains('persistence')) {
            clearElement(child)
            child.onclick = null
            child.onchange = null
        }

        element.removeChild(child)
    }
}

// ç½‘ç»œ
let retryWaitingTime=5000
let nextRequestTime=500

function httpReq(url, args = null, method = 'get', timeout = 10) {
    if(args){
        for(let key in args){
            if(args[key]===null||args[key]===undefined)delete args[key]
        }
    }

    // ç»Ÿä¸€è¿”å›ç»“æ„
    const createResult = (error, data, text) => ({ error, data, text })

    // å‚æ•°é¢„å¤„ç†
    method = method.toUpperCase()
    let finalUrl = url
    let options = { method }

    // å¤„ç† GET/POST å‚æ•°
    if (method === 'GET' && args) {
        finalUrl += `?${new URLSearchParams(args).toString()}`
    } else if (method === 'POST') {
        options.headers = { 'Content-Type': 'application/json' }
        options.body = JSON.stringify(args || {})
    }

    // è¶…æ—¶æ§åˆ¶å™¨
    const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('timeout')), timeout * 1000)
    })

    // å‘é€è¯·æ±‚
    return Promise.race([
        fetch(finalUrl, options)
        .then(async response => {
            const text = await response.text();
            try {
                return createResult(null, JSON.parse(text), text);
            } catch {
                return createResult(null, text, text);
            }
        }),
        timeoutPromise
    ]).catch(error => {
        return createResult(error.message || 'network error', null)
    })
}

MID=null
async function getOsuData(target='match',id=MID,test=false,param={}){
    let time=new Date()
    param.k=apikey.osu
    if(target=='match'){
        param.mp=id
    } else if(target=='user') {
        param.u=id
        param.type ='string'
    } else if(target=='beatmaps'){
        param.b=id
        param.m=0
    } else {
        return null
    }

    let res = await httpReq('https://osu.ppy.sh/api/get_'+target,param)
    let error=null
    if(res.data){
        if(res.data.error)error='è·å–æ¸¸æˆä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥osu apikey'
        if(typeof(res.data)!='object')error='è·å–æ¸¸æˆä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
    }else if(res.error){
        if(res.error=='Failed to fetch'){
            error='è·å–æ¸¸æˆä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥osu apikeyæˆ–ç½‘ç»œè¿æ¥'
        }else{
            error='è·å–æ¸¸æˆä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
        }
    }
    if(error)res.error=error
    updateAlert('osu',time,error)

    if(error&&test){
        setTimeout(()=>{
            getOsuData(target,id,true)
        },retryWaitingTime)
    }
    return res
}
async function saveCache(data,cacheName=Mode,test=false){
    let time=new Date()
    let res = await httpReq('https://cache.flf.moe/cache/mp5pubg_'+cacheName,{api_key:apikey.cache,value:data},'post')
    let error=null
    if(res.data=='API KEYé”™è¯¯')error='è¿æ¥ç¼“å­˜æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥cache apikey'
    else if(res.error)error='è¿æ¥ç¼“å­˜æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
    if(error)res.error=error
    updateAlert('cache',time,error)

    if(error&&test){
        setTimeout(()=>{
            saveCache(data,cacheName,true)
        },retryWaitingTime)
    }
    return res
}

// IDå…ƒç´ å¸¸é‡
const main=document.getElementById('main')
const general=document.getElementById('general')
const configui=document.getElementById('configui')
const stage=document.getElementById('stage')
const cmdTable=document.getElementById('cmdTable')
const mainTable=document.getElementById('mainTable')
const mainTableBanner=document.getElementById('mainTableBanner')
const mainConsole=document.getElementById('mainConsole')
const scoreboard=document.getElementById('scoreboard')
const scoreboardHeader=document.getElementById('scoreboardHeader')

// apikeyä¸è­¦å‘Š
const apikey={
    cache:'',
    osu:'',
}
{
    const alertLogo=document.getElementById('alertLogo')
    const alertTip = document.getElementById('alertTip')
    const alertInfo={
        cache:{time:new Date(),error:null},
        osu:{time:new Date(),error:null},
    }

    alertLogo.addEventListener('mouseenter', () => {
        alertTip.classList.add('active')
    })

    alertLogo.addEventListener('mouseleave', () => {
        alertTip.classList.remove('active')
    })
    function updateAlert(type,time,error){
        if(time<alertInfo[type].time)return
        alertInfo[type]={time,error}
        let text=[]
        if(alertInfo.cache.error)text.push(alertInfo.cache.error)
        if(alertInfo.osu.error)text.push(alertInfo.osu.error)
        if(alertTip.textContent=text.join('\n')){
            alertLogo.classList.remove('hidden')
        }else{
            alertLogo.classList.add('hidden')
            alertTip.classList.remove('active')
        }
    }

    function testApi(){
        getOsuData('user','',true)
        saveCache(null,'test',true)
    }
}
{
    let y=configui.querySelectorAll('input')
    function saveConfig(){
        apikey.cache=y[0].value
        apikey.osu=y[1].value
        if(y[2].checked){
            localStorage.setItem('apikey',apikey.osu)
            localStorage.setItem('cache_apikey',apikey.cache)
        }else{
            localStorage.removeItem('apikey')
            localStorage.removeItem('cache_apikey')
        }
        configui.classList.add('hidden')
        testApi()
    }
    // åˆå§‹åŒ–
    y[0].value=apikey.cache=localStorage.getItem('cache_apikey')
    y[1].value=apikey.osu=localStorage.getItem('apikey')
    if(apikey.cache||apikey.osu){
        y[2].checked=true
        if(apikey.cache&&apikey.osu){
            configui.classList.add('hidden')
            testApi()
        }
    }
    
}
//  é…ç½®
DefaultConfig={
    'mp5':{
        TOURNAMENT:'MP5PUBG',
        order:function(x){ // p=éšæœºç©å®¶å›¾ h=éšæœºå›ºå®šå›¾ o=é¡ºåºå›ºå®šå›¾ a=éšæœºä»»æ„å›¾ // è¯·ä¸è¦æ··ç”¨aä¸å…¶ä»–å­—æ¯ï¼Œæˆ–æ··ç”¨hå’Œo
            const custom={
                2:[
                    {            game:'aaaaaaa'},
                ],
                3:[
                    {playerEnd:2,game:'aaaa'},
                    {            game:'aaaa'},
                ],
                4:[
                    {playerEnd:3,game:'aaa'},
                    {playerEnd:2,game:'aaa'},
                    {            game:'aaa'},
                ],
                5:[
                    {playerEnd:4,game:'aaa'},
                    {playerEnd:3,game:'aaa'},
                    {playerEnd:2,game:'aa'},
                    {            game:'aa'},
                ],
            }
            const playerNum={
                6: [5,4,3,2],
                7: [6,5,4,3],
                8: [6,5,4,3],
                9: [7,5,4,3],
                10:[8,6,4,3],
                11:[9,7,5,3],
                12:[9,7,5,3],
                13:[10,7,5,3],
                14:[11,8,5,3],
                15:[12,9,6,3],
            }
            if(x in custom)return custom[x]
            if(x in playerNum){
                const r=[]
                let lastP=x+1
                for(let y of playerNum[x]){
                    r.push({playerEnd:y,game:'a'.repeat(lastP-y+1)})
                    lastP=y
                }
                r.push({game:'a'.repeat(lastP)})
                return r
            }
            return null
        },
        modMultiply:{
            EZ: 1.5,
            DT: 1/1.2,
            HT: 1/0.3,
        },
        awardMultiply: 1.5,
        showFixed: true,
        totalPointsFunction: function(x){
            let sum=0
            for(let s of x.score)
                if(s.game)sum+=s.points
            return sum
        },
        pointsFunction: function(x,n){ // xè¡¨ç¤ºåæ¬¡ï¼Œnè¡¨ç¤ºå‰©ä½™äººæ•°ï¼ŒNè¡¨ç¤ºæ€»äººæ•°
            return (n-x+1)*Config.constCoef*100/n
        },
        rankFunction: function(x,y){
            const alive=y.alive-x.alive
            if(alive)return alive
            const currentPoints=y.currentPoints-x.currentPoints
            if(currentPoints)return currentPoints
            function sumZ(z){
                let sum=0
                for(let s of z.score)
                    if(s.zscore)sum+=s.zscore
                return sum
            }
            const zscore=sumZ(y)-sumZ(x)
            return zscore
        },
        constCoef:11639628,
        pointsDecimals:0, // æ˜¾ç¤ºå°æ•°ä½æ•°
    },
    'pager':{
        TOURNAMENT:'POBG S4',
        order:function(x){ // p=éšæœºç©å®¶å›¾ h=éšæœºå›ºå®šå›¾ o=é¡ºåºå›ºå®šå›¾ a=éšæœºä»»æ„å›¾ // è¯·ä¸è¦æ··ç”¨aä¸å…¶ä»–å­—æ¯ï¼Œæˆ–æ··ç”¨hå’Œo
            const custom={
                2:[
                    {            game:'ppo'},
                ],
                3:[
                    {playerEnd:2,game:'opp'},
                    {            game:'po'},
                ],
                4:[
                    {playerEnd:3,game:'opp'},
                    {playerEnd:2,game:'op'},
                    {            game:'po'},
                ],
                5:[
                    {playerEnd:4,game:'opp'},
                    {playerEnd:3,game:'op'},
                    {playerEnd:2,game:'po'},
                    {            game:'po'},
                ],
                6:[
                    {playerEnd:5,game:'opp'},
                    {playerEnd:4,game:'op'},
                    {playerEnd:3,game:'op'},
                    {playerEnd:2,game:'po'},
                    {            game:'po'},
                ],
                7:[
                    {playerEnd:6,game:'opp'},
                    {playerEnd:4,game:'opp'},
                    {playerEnd:3,game:'op'},
                    {playerEnd:2,game:'po'},
                    {            game:'po'},
                ],
                8:[
                    {playerEnd:6,game:'oppp'},
                    {playerEnd:4,game:'opp'},
                    {playerEnd:3,game:'op'},
                    {playerEnd:2,game:'po'},
                    {            game:'po'},
                ],
                9:[
                    {playerEnd:7,game:'oppp'},
                    {playerEnd:5,game:'opp'},
                    {playerEnd:3,game:'opp'},
                    {playerEnd:2,game:'po'},
                    {            game:'po'},
                ],
                10:[
                    {playerEnd:7,game:'opppp'},
                    {playerEnd:5,game:'opp'},
                    {playerEnd:3,game:'opp'},
                    {playerEnd:2,game:'po'},
                    {            game:'po'},
                ],
                11:[
                    {playerEnd:8,game:'opppp'},
                    {playerEnd:5,game:'oppp'},
                    {playerEnd:3,game:'opp'},
                    {playerEnd:2,game:'po'},
                    {            game:'po'},
                ],
                12:[
                    {playerEnd:9,game:'opppp'},
                    {playerEnd:5,game:'opppp'},
                    {playerEnd:3,game:'opp'},
                    {playerEnd:2,game:'po'},
                    {            game:'po'},
                ],
                13:[
                    {playerEnd:10,game:'opppp'},
                    {playerEnd:6,game:'opppp'},
                    {playerEnd:3,game:'oppp'},
                    {playerEnd:2,game:'po'},
                    {            game:'po'},
                ],
                14:[
                    {playerEnd:11,game:'opppp'},
                    {playerEnd:7,game:'opppp'},
                    {playerEnd:5,game:'opp'},
                    {playerEnd:3,game:'ppo'},
                    {playerEnd:2,game:'po'},
                    {            game:'po'},
                ],
                15:[
                    {playerEnd:12,game:'opppp'},
                    {playerEnd:8,game:'opppp'},
                    {playerEnd:5,game:'oppp'},
                    {playerEnd:3,game:'ppo'},
                    {playerEnd:2,game:'po'},
                    {            game:'po'},
                ],
                16:[
                    {playerEnd:13,game:'opppp'},
                    {playerEnd:9,game:'opppp'},
                    {playerEnd:6,game:'oppp'},
                    {playerEnd:3,game:'pppo'},
                    {playerEnd:2,game:'po'},
                    {            game:'po'},
                ],
            }
            if(x in custom)return custom[x]
            return null
        },
        modMultiply:{
            EZ: 2,
        },
        awardMultiply: 1,
        showFixed: false,
        totalPointsFunction: function(x){
            let sum=0
            let i=x.score.length-1
            while(i>=0){
                if(x.score[i].game)sum+=x.score[i].points
                else break
                i--
            }
            return sum
        },
        pointsFunction: function(x,n){ // xè¡¨ç¤ºåæ¬¡ï¼Œnè¡¨ç¤ºå‰©ä½™äººæ•°ï¼ŒNè¡¨ç¤ºæ€»äººæ•°
            return n-x+1
        },
        rankFunction: function(x,y){
            const alive=y.alive-x.alive
            if(alive)return alive
            const currentPoints=y.currentPoints-x.currentPoints
            if(currentPoints)return currentPoints
            function sumZ(z){
                let sum=0
                let i=x.score.length-1
                while(i>=0){
                    if(x.score[i].game)sum+=x.score[i].score
                    else break
                    i--
                }
                return sum
            }
            const zscore=sumZ(y)-sumZ(x)
            return zscore
        },
        constCoef:1,
        pointsDecimals:0,
    },
}
function initConfig(){
    let mode=(new URLSearchParams(window.location.search)).get('name')
    if(!(mode in DefaultConfig))mode='mp5'
    document.getElementById('modeLogo').src=`assets/${mode}.png`
    document.getElementById('modeLogo').title=`è£åˆ¤è¡¨å½“å‰ä¸º${mode}æ¨¡å¼ï¼Œè¯·åœ¨æ§åˆ¶å°ä¸­è¾“å…¥â€œMODE('æ¨¡å¼å')â€ä»¥æ›´æ”¹ï¼Œæˆ–ç›´æ¥è®¿é—®https://mp5tournament.github.io/pubg/?name=ä½ çš„modeã€‚`
    return [mode, DefaultConfig[mode]]
}
function MODE(mode){
    mode=mode||''
    if(mode){
        mode=mode.toLocaleLowerCase()
        if(!(mode in DefaultConfig))return 'æ²¡æœ‰è¿™ä¸ªæ¨¡å¼'
        window.location.search='?name='+mode
    }
    else window.location.search=''
}
const [Mode, Config]=initConfig()
// ä¼ é€’Data
let Order=null
const OsuData={
    user:{},
    beatmap:{},
}
let N=0
let MatchName=null
const MatchResult={}
const MatchOrder=[]
const MatchResultRank=[]
const Beatmap={  // {username,bid,mod,award}
    host:[],
    player:[]
}
const Match={
    data:[],
    lastText:null,
    monitor:async function() {
        const res = await getOsuData()
        let update = null
        try{
            asserts(!res.error)
            asserts(res.text!=Match.lastText)
            asserts(res.data.games)
            Match.data=res.data.games
            Match.lastText=res.text
            update=currentStage.score.update
        }catch{}
        if(update)update()
    },
    start:function(){
        setInterval(Match.monitor,retryWaitingTime)
    },
}
const Uid2Uasername={}

// ä¸»æµç¨‹
const PlayerDom={}
const RemainingPlayer=[]
const RemainingBeatmap={
    host:[],
    player:[]
}
let order=null
const Progress={
    round:null,
    game:null,
    next:function(){
        for(let x in MatchResult){
            MatchResult[x].currentPoints=Config.totalPointsFunction(MatchResult[x])
            PlayerDom[x].scorePoints.textContent=format(MatchResult[x].currentPoints/Config.constCoef,0,Config.pointsDecimals)
        }

        if(Progress.round===null){
            Progress.round=Progress.game=0
        } else if(Progress.game===null) {
            Progress.round+=1
            Progress.game=0
        } else {
            Progress.game+=1
            if(Progress.game>=Order[Progress.round].game.length)
                Progress.game=null
        }

        if(Progress.game===null){
            currentStage=StageE
            stage.textContent=`ç»“ç®—é˜¶æ®µ${Progress.round+1}`
        }else{
            currentStage=StageG
            stage.textContent=`æ¯”èµ›é˜¶æ®µ${Progress.round+1}-${Progress.game+1}`
        }

        reRank()
        
        clearElement(scoreboard)
        scoreboard.appendChild(scoreboardHeader)
        for(let x of MatchResultRank)scoreboard.appendChild(PlayerDom[x.username].score)

        saveCache({
            timestamp:Date.now(),
            OsuData,
            MatchResult:MatchResultRank,
            MatchOrder,
            Order,
            RemainingBeatmap,
            RemainingPlayer,
            MatchName,
            Beatmap,
            Progress:{round:Progress.round,game:Progress.game},
            Config:{
                modMultiply:Config.modMultiply,constCoef:Config.constCoef,pointsDecimals:Config.pointsDecimals,
                showFixed: Config.showFixed,showAward:Config.awardMultiply!=1
            },
        })

        order=Order[Progress.round]
        currentStage.init()
    }
}
function reRank(){
    MatchResultRank.sort(Config.rankFunction)
    for(let i in MatchResultRank)
        PlayerDom[MatchResultRank[i].username].score.querySelector('.rank').textContent=MatchResultRank[i].rank=Number(i)+1
}
function writeCMD(cmd){
    clearElement(cmdTable)
    cmd.forEach((c) => {
        cmdTable.innerHTML+=`<div onclick="copyText(this)" title="${c}">${c}</div>`
    })
}

// å‡†å¤‡é˜¶æ®µ
const StageP={
    updateMID:function(element){
            async function checkMatch(){
                let {error,data}=await getOsuData('match',mid)
                let class_='pending'
                let title=null
                try{
                    asserts(data.match.name)

                    MatchName=data.match.name
                    
                    let text=[]

                    if(!data.match.name.startsWith(Config.TOURNAMENT)){
                        text.push(`æˆ¿é—´åä¸º${data.match.name}ï¼Œæ²¡æœ‰ä»¥${Config.TOURNAMENT}å¼€å¤´`)
                    }
                    
                    let t=new Date(data.match.start_time+'Z')
                    if(Date.now()-t.getTime()>30*60*1000) {
                        text.push(`å¼€å§‹æ—¶é—´${t.toLocaleString().replace(/\//g,'-')}ï¼Œè·ç¦»å½“å‰æ—¶åˆ»å¾ˆä¹…`)
                    }

                    if(text.length){
                        class_='warning'
                        title=`å½“å‰æ‰€é€‰æ‹©çš„æˆ¿é—´${mid}çš„${text.join('ï¼Œä¸”å…¶')}ï¼Œè¿™çœŸçš„æ˜¯æœ¬åœºæ¯”èµ›çš„æˆ¿é—´å—ï¼Ÿ`
                    } else {
                        class_='checked'
                    }
                }catch{
                    if(error){
                        title=error
                    }else{
                        title='æ²¡æœ‰æ‰¾åˆ°è¿™åœºæ¯”èµ›'
                        class_='error'
                    }
                }
                if(MID!=mid)return
                if(title)element.title=title
                element.className=class_
                if(class_=='pending')setTimeout(checkMatch,retryWaitingTime)
            }

            let x=element.value
            let mid=null
            if(x){
                x=x.trim().split('/')
                if(x.length==1){
                    x=x[0]
                } else {
                    x=x[x.length-1]?x[x.length-1]:x[x.length-2]
                }
                if(/^\d+$/.test(x)){
                    mid=x.trim()
                }
            }

            if(MID!=mid){
                element.className='pending'
                element.removeAttribute('title')
                MID=mid
                if(mid)checkMatch()
            }
        },
    add:function(){
        let alertText=[]
        for(let raw of mainConsole.querySelector('textarea').value.split('\n')){
            raw=raw.trim()
            if(!raw)continue
            let line=[]
            for(let x of raw.split('\t'))line.push(x.trim())
            let m={}
            let modAll=''
            if(/^\d+$/.test(line[1])){
                m.username=line[0]
                m.bid=line[1]
                modAll=line.slice(2).join('')
                m.checked=false
            } else if(/^\d+$/.test(line[0])){
                m.username=''
                m.bid=line[0]
                modAll=line.slice(1).join('')
                m.checked=true
            } else {
                alertText.push(`è¯¥è¡Œæ ¼å¼é”™è¯¯ï¼šâ€œ${raw.replaceAll('\t',' | ')}â€`)
                continue
            }
            modAll=modAll.toLocaleUpperCase()
            let modS=new Set()
            let modF=new Set()
            let modA=new Set()
            let modSet=new Set()
            while(modAll){
                modSet.add(modAll.slice(0,2))
                modAll=modAll.slice(2)
            }
            for(let x of modSet){
                switch(x) {
                    case 'DT':
                    case 'NC':
                    case 'HT':
                        modS.add(x)
                        break
                    case 'EZ':
                    case 'HR':
                        modF.add(x)
                        break
                    case 'HD':
                    case 'FL':
                    case 'SO':
                        modA.add(x)
                        break
                    case 'NM':
                    case 'V2':
                    case 'NF':
                        break
                    default:
                        alertText.push(`è¯¥è¡ŒMODæˆ–æ ¼å¼é”™è¯¯ï¼šâ€œ${raw.replaceAll('\t',' | ')}â€`)
                        continue
                }
            }
            if(modS.size>1||modF.size>1){
                alertText.push(`è¯¥è¡ŒMODæˆ–æ ¼å¼é”™è¯¯ï¼šâ€œ${raw.replaceAll('\t',' | ')}â€`)
                continue
            }
            if(m.username&&StageP.table.playerSet.has(m.username)){
                alertText.push(`è¯¥ç”¨æˆ·å·²åœ¨è¡¨ä¸­ï¼šâ€œ${m.username}â€`)
                continue
            }
            if(StageP.table.mapSet.has(m.bid)){
                alertText.push(`è¯¥å›¾å·²åœ¨è¡¨ä¸­ï¼šâ€œ${m.bid}â€`)
                continue
            }
            m.mod=[...modS].join('')||'NM'
            const awardMods=[...modA].concat([...modF])
            awardMods.sort()
            m.award=(awardMods.join(''))||'NM'
            if(m.username)StageP.table.player.push(m)
            else StageP.table.host.push(m)
        }
        mainConsole.querySelector('textarea').value=''
        alertText=alertText.join('\n')
        if(alertText)alert(alertText)
        StageP.refresh()
    },
    clear:function(){
        if(!confirm('è¿™å°†æ¸…ç©ºå·¦ä¾§å…¨éƒ¨å†…å®¹ï¼Œä½ ç¡®å®šè¦è¿™æ ·åšå—ï¼Ÿ'))return
        StageP.table.host.length=0
        StageP.table.player.length=0
        StageP.refresh()
    },
    check:function(element){
        let tr=element.closest('tr')
        let type=tr.getAttribute('data-type')
        let id=tr.getAttribute('data-id')
        if(type!='player')return
        if(StageP.table[type][id].checked=!StageP.table[type][id].checked){
            element.textContent='âœ”ï¸'
            tr.classList.remove('waiting')
        }else{
            element.textContent='â³'
            tr.classList.add('waiting')
        }
    },
    delete:function(element){
        let tr=element.closest('tr')
        let type=tr.getAttribute('data-type')
        let id=tr.getAttribute('data-id')
        StageP.table[type].splice(id,1)
        StageP.refresh()
    },
    refresh(){
        function addMap({username,bid,mod,award,checked}){
            text.push(`<tr data-type="${username?'player':'host'}" data-id="${i++}"${checked?'':' class="waiting"'}">
    <td${(username&&OsuData.user[username]===-1)?' class="username error" title="æ²¡æœ‰æ‰¾åˆ°è¯¥ç©å®¶"':' class="username"'}>${username||('å›ºå®šå›¾'+i)}</td>
    <td${(OsuData.beatmap[bid]===-1)?' class="bid error" title="æ²¡æœ‰æ‰¾åˆ°è¯¥å›¾"':' class="bid"'}>${bid}</td>
    <td class="mod">${mod}</td>
    <td class="award">${award}</td>
    <td class="button"><button onclick="StageP.check(this)" class="blue small"${username?'':' disabled'}>${checked?'âœ”ï¸':'â³'}</button></td>
    <td class="button"><button onclick="StageP.delete(this)" class="red small">ğŸ—‘ï¸</button></td>
</tr>`)

            try{
                asserts(OsuData.beatmap[bid].mod==mod)
            }catch{
                newMap.push({bid,mod})
                OsuData.beatmap[bid]=null
            }
            if(username&&!(username in OsuData.user)){
                newUser.push(username)
                OsuData.user[username]=null
            }
            StageP.table.mapSet.add(bid)
            if(username){
                StageP.table.playerSet.add(username)
                cmd.push('!MP INVITE '+username)
            }
        }
        let text=[]
        let newMap=[]
        let newUser=[]
        let cmd=[`!MP MAKE ${Config.TOURNAMENT}: (æˆ¿é—´å)`,'!MP SET 0 3','!MP ADDREF','!MP SETTINGS']
        StageP.table.mapSet=new Set()
        StageP.table.playerSet=new Set()

        let i=0
        for(let map of StageP.table.host)addMap(map)
        i=0
        for(let map of StageP.table.player)addMap(map)

        clearElement(mainTable)
        mainTable.innerHTML=text.join('\n')
        writeCMD(cmd)

        newMap.forEach(({bid,mod}, i) => {
            async function f() {
                if(!StageP.table.mapSet.has(bid)){
                    delete OsuData.beatmap[bid]
                    return
                }
                let mods=0
                if(mod=='DT')mods=64
                if(mod=='HT')mods=256
                let {error,data}=await getOsuData('beatmaps',bid,false,{mods})
                if(error){
                    setTimeout(f, retryWaitingTime)
                } else {
                    if(data.length){
                        OsuData.beatmap[bid]=data[0]
                        OsuData.beatmap[bid].mod=mod
                    } else {
                        OsuData.beatmap[bid]=-1
                        StageP.refresh()
                    }
                }
            }
            setTimeout(f, i * nextRequestTime)
        })
        newUser.forEach((username, i) => {
            async function f() {
                if(!StageP.table.playerSet.has(username)){
                    delete OsuData.user[username]
                    return
                }
                let {error,data}=await getOsuData('user',username)
                if(error){
                    setTimeout(f, retryWaitingTime)
                } else {
                    if(data.length&&data[0].username.toLocaleUpperCase()==username.toLocaleUpperCase()){
                        OsuData.user[username]=data[0]
                    } else {
                        OsuData.user[username]=-1
                        StageP.refresh()
                    }
                }
            }
            setTimeout(f, i * nextRequestTime)
        })
    },
    table:{
        host:[],
        player:[],
        mapSet:new Set(),
        playerSet:new Set(),
    },
    nextStage:function(){
        let flag=false
        Beatmap.host.length=0
        Beatmap.player.length=0

        function verify({username,bid,mod,award,checked}){
            if(!checked)return false
            
            if(username){
                let u=OsuData.user[username]
                if(!u){
                    flag=true
                } else if(u===-1){
                    alert('æœ‰é€‰æ‰‹å‡ºç°é”™è¯¯ï¼ˆé«˜äº®çº¢å­—ï¼‰ï¼Œè¯·å…ˆåˆ é™¤è¿™äº›é”™è¯¯çš„é¡¹ç›®å†ç»§ç»­ã€‚')
                    return true
                }
                
                Beatmap.player.push({username,bid,mod,award})
            } else {
                Beatmap.host.push({username,bid,mod,award})
            }

            let b=OsuData.beatmap[bid]
            if(!b){
                flag=true
            } else if(b===-1){
                alert('æœ‰å›¾å‡ºç°é”™è¯¯ï¼ˆé«˜äº®çº¢å­—ï¼‰ï¼Œè¯·å…ˆåˆ é™¤è¿™äº›é”™è¯¯çš„é¡¹ç›®å†ç»§ç»­ã€‚')
                return true
            }
            return false
        }

        for(let x of StageP.table.host){
            if(verify(x))return
        }
        for(let x of StageP.table.player){
            if(verify(x))return
        }

        if(flag){
            alert('éƒ¨åˆ†å›¾æˆ–é€‰æ‰‹ä¿¡æ¯è¿˜åœ¨è·å–ä¸­ï¼Œè¯·ç¨åé‡è¯•ã€‚å¦‚æœå·¦ä¾§å·¥å…·æ å‡ºç°å¹å·ï¼Œè¯·å…ˆè§£å†³ç›¸åº”é—®é¢˜ã€‚')
            return
        }

        Order=Config.order(Beatmap.player.length)
        if(!Order){
            alert(`ä¸æ”¯æŒå½“å‰çš„ç©å®¶æ•°é‡ï¼š${Beatmap.player.length}ã€‚\nè¯·æ£€æŸ¥å›¾æ± ä¸é€‰æ‰‹é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠæ˜¯å¦æ­£ç¡®ç­¾åˆ°ã€‚`)
            return
        }

        let n=0
        for(let x of Order)n+=x.game.length
        if(n!==Beatmap.player.length+Beatmap.host.length){
            alert(`å½“å‰çš„ç©å®¶æ•°é‡æ˜¯${Beatmap.player.length}ï¼Œåº”æœ‰${n-Beatmap.player.length}å¼ å›ºå®šå›¾ï¼Œä½†å®é™…æœ‰${Beatmap.host.length}å¼ ã€‚\nè¯·æ£€æŸ¥å›¾æ± ä¸é€‰æ‰‹é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠæ˜¯å¦æ­£ç¡®ç­¾åˆ°ã€‚`)
            return
        }

        
        switch(mainConsole.querySelector('input').className){
            case 'warning':
                if(!confirm(mainConsole.querySelector('input').title))return
                break
            case 'checked':
                break
            case 'error':
                alert('æˆ¿é—´å‡ºç°é”™è¯¯ï¼ˆé«˜äº®çº¢å­—ï¼‰ï¼Œè¯·æ£€æŸ¥MPLinkæˆ–MatchIDæ˜¯å¦æ­£ç¡®ã€‚')
                return
            case 'pending':
                alert('æˆ¿é—´ä¿¡æ¯è¿˜åœ¨è·å–ä¸­ï¼Œè¯·ç¨åé‡è¯•ã€‚å¦‚æœå·¦ä¾§å·¥å…·æ å‡ºç°å¹å·ï¼Œè¯·å…ˆè§£å†³ç›¸åº”é—®é¢˜ã€‚')
                return
            default:
                alert('è¯·å…ˆåœ¨å³ä¾§å¡«å…¥æˆ¿é—´ä¿¡æ¯ã€‚')
                return
        }
        
        if(!confirm(StageP.table.player==Beatmap.player.length?
        `ä½ ç¡®å®šè¦è¿›å…¥ä¸‹é˜¶æ®µå—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚\né…ç½®ä¸­å…±æœ‰${StageP.table.player.length}åç©å®¶ï¼Œå…¶ä¸­${Beatmap.player.length}äººå·²ç­¾åˆ°ï¼Œ${StageP.table.player.length-Beatmap.player.length}äººæœªç­¾åˆ°ã€‚\næœªç­¾åˆ°çš„ç©å®¶å°†æ— æ³•å‚ä¸æ¸¸æˆã€‚`:
        `ä½ ç¡®å®šè¦è¿›å…¥ä¸‹é˜¶æ®µå—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚\né…ç½®ä¸­å…±æœ‰${StageP.table.player.length}åç©å®¶ï¼Œå…¨éƒ¨ç©å®¶å‡å·²ç­¾åˆ°ã€‚`)) return

        let lastR=Beatmap.player.length
        for(let i in Order){
            Order[i].playerStart=lastR
            lastR=Order[i].playerEnd
        }

        window.onbeforeunload=()=>true
        
        RemainingBeatmap.host=[...Beatmap.host]
        RemainingBeatmap.player=[...Beatmap.player]

        let i=1
        for(let x of RemainingBeatmap.host){
            x.host=i++
        }

        function createPlayerDom(username){
            N++
            const main=document.createElement('tr')
            main.className='persistence'
            main.innerHTML=`
<td class="username" title="${username}">${username}</td>
<td class="raw_score"><input type="number"></td>
<td class="mod"><input></td>
<td class="score"></td>
`
            const [mainInputS,mainInputM]=main.querySelectorAll('input')
            mainInputS.addEventListener('change', () =>{
                StageG.score.change(username)
            })
            mainInputM.addEventListener('change', () =>{
                StageG.score.change(username)
            })
            const score=document.createElement('tr')
            score.className='persistence'
            score.innerHTML=`
<td class="rank"></td>
<td class="username" title="${username}">${username}</td>
<td class="button"><button onclick="copyText(null,'!MP INVITE ${username}')" class="blue small">ğŸ‘‹</button></td>
<td class="button"><button onclick="copyText(null,'!MP KICK ${username}')" class="red small">ğŸš«</button></td>
<td class="points"></td>
`
            return {main,mainInputS,mainInputM,mainScore:main.querySelector('.score'),score,scorePoints:score.querySelector('.points')}
        }
        for(let x of Beatmap.player){
            x=x.username
            const y={
                username:x,
                alive:true,
                score:[],
                points:[],
                currentPoints:0,
                rank:null
            }
            MatchResult[x]=y
            MatchResultRank.push(y)
            PlayerDom[x]=createPlayerDom(x)
            RemainingPlayer.push(x)
            Uid2Uasername[OsuData.user[x].user_id]=x
        }
        scoreboardHeader.innerHTML=`
<td class="rank">#</td>
<td class="username">ç©å®¶</td>
<td class="button" title="å¤åˆ¶è¯¥ç©å®¶çš„é‚€è¯·å‘½ä»¤">é‚€</td>
<td class="button" title="å¤åˆ¶è¯¥ç©å®¶çš„è¸¢å‡ºå‘½ä»¤">è¸¢</td>
<td class="points" title="å½“å‰è½®æ¬¡æ€»ç§¯åˆ†">ç§¯åˆ†</td>
`
        mainTableBanner.style.height='35px'
        Match.start()
        Progress.next()
    }
}
const StageG={
    init:function(){
        StageG.map=null
        StageG.optionalMap.length=0

        let mapText=null
        switch(order.game[Progress.game]){
            case 'p':
                StageG.optionalMap=[...RemainingBeatmap.player]
                if(StageG.optionalMap.length>1){
                    mapText='ä½¿ç”¨éšæœºè‡ªé€‰å›¾ï¼Œæ¥ä¸‹æ¥å°†åœ¨ç›´æ’­é—´è¿›è¡ŒéšæœºæŠ½å–ã€‚'
                }else{
                    mapText='ä½¿ç”¨éšæœºè‡ªé€‰å›¾ã€‚æ­¤ç±»å›¾ä»…å‰©ä¸€å¼ ï¼Œå°†ç›´æ¥ä½¿ç”¨è¯¥å›¾ã€‚'
                    StageG.map=StageG.optionalMap[0]
                }
                break
            case 'h':
                StageG.optionalMap=[...RemainingBeatmap.host]
                if(StageG.optionalMap.length>1){
                    mapText='ä½¿ç”¨éšæœºå›ºå®šå›¾ï¼Œæ¥ä¸‹æ¥å°†åœ¨ç›´æ’­é—´è¿›è¡ŒéšæœºæŠ½å–ã€‚'
                }else{
                    mapText='ä½¿ç”¨éšæœºå›ºå®šå›¾ã€‚æ­¤ç±»å›¾ä»…å‰©æœ€åä¸€å¼ ï¼Œå°†ç›´æ¥ä½¿ç”¨è¯¥å›¾ã€‚'
                    StageG.map=StageG.optionalMap[0]
                }
                break
            case 'o':
                mapText='æŒ‰é¡ºåºä½¿ç”¨å›ºå®šå›¾ã€‚'
                StageG.optionalMap=[RemainingBeatmap.host[0]]
                StageG.map=StageG.optionalMap[0]
                break
            case 'a':
                StageG.optionalMap=[...RemainingBeatmap.host].concat([...RemainingBeatmap.player])
                if(StageG.optionalMap.length>1){
                    mapText='æ¥ä¸‹æ¥å°†åœ¨ç›´æ’­é—´è¿›è¡ŒéšæœºæŠ½å–ã€‚'
                }else{
                    mapText='ä»…å‰©æœ€åä¸€å¼ èµ›å›¾ï¼Œå°†ç›´æ¥ä½¿ç”¨è¯¥å›¾ã€‚'
                    StageG.map=StageG.optionalMap[0]
                }
                break
        }
        StageG.cmd.part0=[
            `æ­£åœ¨è¿›è¡Œç¬¬${Progress.round+1}/${Order.length}è½®ï¼Œ`+
            (order.playerEnd?
                `å½“å‰å­˜æ´»${order.playerStart}åç©å®¶ï¼Œæœ¬è½®ç»“æŸåå°†æ·˜æ±°${order.playerStart-order.playerEnd}åç©å®¶ã€‚`:
                `æœ¬è½®æ˜¯æœ€ç»ˆè½®ï¼Œå‰©ä½™${order.playerStart}åç©å®¶å°†å…±åŒå†³å‡ºæœ¬åœºæ¯”èµ›çš„å† å†›ã€‚`
            ),
            `æœ¬å±€æ˜¯æœ¬è½®çš„ç¬¬${Progress.game+1}/${order.game.length}å±€ï¼Œ${mapText}`
        ]
        if(!StageG.map){
            StageG.cmd.part0.push(`!MP ROLL ${StageG.optionalMap.length}`)
            StageG.optionalMap=[null].concat([...StageG.optionalMap])
        }

        let selectMapText=[]
        for(let x of StageG.optionalMap){
            let text=''
            if(x){
                text=`${'&ensp;'.repeat(7-x.bid.length)}${x.bid} ï¼ˆ${x.username?x.username:('å›ºå®šå›¾'+x.host)}ï¼‰`
            } else {
                text='ï¼ˆè¯·é€‰æ‹©ï¼‰'
            }
            selectMapText.push(`    <option>${text}</option>`)
        }
        
        clearElement(mainTable)
        clearElement(mainConsole)
        clearElement(mainTableBanner)
        mainTableBanner.innerHTML=`
<input style="float:left;margin:0 5px 0 3px" type="checkbox" checked onchange="if(this.checked)StageG.score.refresh()"><div style="line-height:30px;float:left">è‡ªåŠ¨è·å–åˆ†æ•°</div>
<div style="float:right;padding-right:1px;">
    <button class="yellow" onclick="StageG.score.refresh()">é‡ç½®åˆ†æ•°</button>
    <button class="red" onclick="StageG.score.clear()">æ¸…ç©ºåˆ†æ•°</button>
</div>
`
        for(let x of RemainingPlayer){
            mainTable.appendChild(PlayerDom[x].main)
        }
        mainConsole.innerHTML=`
<div${StageG.map?' class="waiting"':''}>rollç‚¹ç»“æœï¼š<span style="user-select:none"
title="é€šå¸¸æ¥è¯´ä½ åº”è¯¥è®©ç›´æ’­å‘˜è¿›è¡Œæ“ä½œæ¥éšæœºæŠ½å–èµ›å›¾ï¼Œä½†ä¹Ÿå¯ä»¥rollç‚¹ã€‚
å½“ä½ è¾“å…¥æˆ–æ›´æ”¹rollç‚¹ç»“æœæ—¶ï¼Œæœ¬å±€èµ›å›¾ä¼šè‡ªåŠ¨æ›´æ”¹ä¸ºrollç‚¹å¯¹åº”çš„å›¾ã€‚
ä½†ä½ ä¹Ÿå¯ä»¥ç›´æ¥ä¿®æ”¹æœ¬å±€èµ›å›¾ã€‚">â“</span></div>
<input onchange="StageG.changeRoll(this)" type="number" step="1" min="1" max="${StageG.optionalMap.length-1}"${StageG.map?' disabled':''}>
<div>æœ¬å±€èµ›å›¾ï¼š</div>
<select data-last="" onchange="StageG.changeMap(this)"${StageG.map?' disabled':''}>
${selectMapText.join('\n')}
</select>
<div>å½“è¯¥å±€è¿›è¡Œå®Œæ¯•ä¹‹åï¼Œå·¦ä¾§è¡¨æ ¼ä¼šè‡ªåŠ¨è·å–é€‰æ‰‹åˆ†æ•°ã€‚å¦‚æœæœ‰å¿…è¦ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥ä¿®æ”¹é€‰æ‰‹åˆ†æ•°ã€‚<span style="user-select:none"
title="åªæœ‰æ‰“å¼€â€œè‡ªåŠ¨è·å–åˆ†æ•°â€æ—¶æ‰ä¼šè‡ªåŠ¨è·å–åˆ†æ•°ï¼Œä¸”è‡ªåŠ¨è·å–åˆ°çš„åˆ†æ•°ä¼šè¦†ç›–æ‰æ‰‹åŠ¨è·å–çš„åˆ†æ•°ã€‚">â“</span></div>
<div>è¿›å…¥ä¸‹é˜¶æ®µåï¼Œæ€»åˆ†æ•°è¡¨æ‰ä¼šæ›´æ–°ï¼Œè¯·åœ¨ç¡®è®¤åˆ†æ•°æ— è¯¯åå°½å¿«è¿›å…¥ä¸‹é˜¶æ®µä»¥è®©ç›´æ’­å‘˜å¯ä»¥å±•ç¤ºæ€»åˆ†æ•°è¡¨ã€‚</div>`
        StageG.score.hasUpdated=false
        StageG.score.default={}
        StageG.cmd.refresh()
        StageG.changeMap()
    },
    map:null,
    optionalMap:[],
    changeRoll:function(element){
        let value=element.value.trim()
        if(!/^\d+$/.test(value)||Number(value)<=0||Number(value)>=StageG.optionalMap.length){
            element.className='error'
            return
        }
        element.className=''
        element=mainConsole.querySelector('select')
        element.selectedIndex=value
        StageG.changeMap(element)
    },
    changeMap:function(element=null){
        if(StageG.score.hasUpdated&&!confirm('æ‚¨ç¡®å®šè¦æ›´æ¢èµ›å›¾å—ï¼Ÿè¿™å°†æ¸…é™¤å·¦ä¾§çš„æ‰€æœ‰åˆ†æ•°ã€‚')){
            element.selectedIndex=element.dataset.last
            return
        }

        if(element){
            element.dataset.last=element.selectedIndex
            StageG.map=StageG.optionalMap[element.selectedIndex]
            StageG.cmd.refresh()
        }
        StageG.score.clear()
        StageG.score.update()
    },
    cmd:{
        part0:[],
        refresh:function(){
            let cmd=StageG.cmd.part0
            if(StageG.map){
                let x=StageG.map.username?
                    `é€‰æ‰‹${StageG.map.username}æ‰€é€‰å›¾ï¼š${StageG.map.bid}${StageG.map.mod=='NM'?'':('+'+StageG.map.mod)}`:
                    `å›ºå®šå›¾${StageG.map.host}ï¼š${StageG.map.bid}${StageG.map.mod=='NM'?'':('+'+StageG.map.mod)}`
                if(Config.awardMultiply!=1){
                    x+=`ï¼Œå¥–åŠ±MODç»„åˆä¸º${StageG.map.award}ï¼Œä½¿ç”¨è¯¥MODç»„åˆå°†è·å¾—${Config.awardMultiply}å€åˆ†æ•°`
                }
                cmd=cmd.concat([
                    `æœ¬å±€å›¾ä¸º${x}ã€‚`,
                    `!MP MAP ${StageG.map.bid}`,
                    `!MP MODS ${StageG.map.mod=='NM'?'':StageG.map.mod} NF FreeMod`,
                    '!MP SETTINGS',
                    '!MP START 7',
                ])
            }
            writeCMD(cmd)
        },
    },
    score:{
        hasUpdated:false,
        clear:function(){
            for(let x of RemainingPlayer){
                const dom=PlayerDom[x]

                dom.mainInputS.value=
                dom.mainInputS.className=
                dom.mainInputM.value=
                dom.mainInputM.className=
                dom.mainScore.dataset.award=''

                dom.mainScore.textContent='0'
                dom.mainScore.classList.remove('warning')

                dom.mainInputS.disabled=dom.mainInputM.disabled=StageG.map?false:true
            }
            if(StageG.score.hasUpdated)
                mainTableBanner.querySelector('input').checked=StageG.score.hasUpdated=false
        },
        update:function(){
            StageG.score.default={}
            if(!StageG.map)return
            let data=null
            for(let i=Match.data.length-1;i>=0;i--){
                const x=Match.data[i]
                if(!x.scores.length)continue
                if(StageG.map.bid==x.beatmap_id){
                    data=x
                    break
                }
            }
            if(data){
                const modsNumAll=Number(data.mods)||0
                StageG.score.default={}
                for(let x of data.scores){
                    const {user_id,enabled_mods,score}=x
                    const modsNum=(Number(enabled_mods)||0)|modsNumAll
                    const mods=[]
                    for(let m in ModsNumDict)
                        if(modsNum&ModsNumDict[m])mods.push(m)
                    StageG.score.default[Uid2Uasername[user_id]]={score,mods:mods.join('') || 'NM'}
                }
                if(!mainTableBanner.querySelector('input').checked)return
                mainTableBanner.querySelector('input').checked=false
                StageG.score.refresh()
            }
            
        },
        refresh:function(){
            let flag=false
            for(let x of RemainingPlayer){
                const dom=PlayerDom[x]
                if(StageG.score.default[x]){
                    const ds=StageG.score.default[x]
                    dom.mainInputS.value=ds.score
                    dom.mainInputM.value=ds.mods
                    StageG.score.change(x)
                    flag=true
                }else{
                    dom.mainInputS.value=
                    dom.mainInputS.className=
                    dom.mainInputM.value=
                    dom.mainInputM.className=
                    dom.mainScore.dataset.award=''

                    dom.mainScore.textContent='0'
                    dom.mainScore.classList.remove('warning')

                    dom.mainInputS.disabled=dom.mainInputM.disabled=StageG.map?false:true
                }
            }
            StageG.score.hasUpdated=flag
        },
        change:function(username){
            const dom=PlayerDom[username]
            let flag=false
            let rscore=format(dom.mainInputS.value) || ''
            dom.mainInputS.value=rscore
            try{
                asserts(StageG.score.default[username].score==rscore)
                dom.mainInputS.classList.remove('warning')
            }catch{
                dom.mainInputS.classList.add('warning')
                flag=true
            }
            let modAll=dom.mainInputM.value.trim().toLocaleUpperCase()
            let modS=''
            let modF=''
            let modA=new Set()
            let modSet=new Set()
            while(modAll){
                modSet.add(modAll.slice(0,2))
                modAll=modAll.slice(2)
            }
            for(let x of modSet){
                switch(x) {
                    case 'NC':
                        modS='DT'
                        break
                    case 'DT':
                    case 'HT':
                        modS=x
                        break
                    case 'EZ':
                    case 'HR':
                        modF=x
                        break
                    case 'HD':
                    case 'FL':
                    case 'SO':
                        modA.add(x)
                        break
                    case 'NM':
                    case 'V2':
                    case 'NF':
                        break
                }
            }
            const mods=[...modA]
            if(modF)mods.push(modF)
            mods.sort()
            let award=((mods.join(''))||'NM')==StageG.map.award&&Config.awardMultiply!=1
            if(modS)mods.push(modS)
            mods.sort()
            dom.mainInputM.value=(mods.join(''))||'NM'
            try{
                asserts(StageG.score.default[username].mods==dom.mainInputM.value)
                dom.mainInputM.classList.remove('warning')
            }catch{
                dom.mainInputM.classList.add('warning')
                flag=true
            }
            if(flag)dom.mainScore.classList.add('warning')
            else dom.mainScore.classList.remove('warning')
            let score=Number(rscore)||0
            for(let x of mods){
                if(x in Config.modMultiply)score*=Config.modMultiply[x]
            }
            if(award){
                score*=Config.awardMultiply
                dom.mainScore.dataset.award=1
            }else{
                dom.mainScore.dataset.award=''
            }
            dom.mainScore.textContent=format(score)
        },
        default:{},
    },
    nextStage:function(){
        if(!StageG.map){
            alert('ä½ è¿˜æ²¡æœ‰é€‰æ‹©æœ¬å±€çš„èµ›å›¾')
            return
        }
        const blanket=[]
        const notDefault=[]
        for(let x of RemainingPlayer){
            if(PlayerDom[x].mainScore.textContent=='0') blanket.push(x)
            else if(PlayerDom[x].mainScore.classList.contains('warning'))notDefault.push(x)
        }
        if(!confirm(`ä½ ç¡®å®šè¦è¿›å…¥ä¸‹é˜¶æ®µå—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚\næœ¬å±€èµ›å›¾æ˜¯${StageG.map.bid} ï¼ˆ${StageG.map.username||('å›ºå®šå›¾'+StageG.map.host)}ï¼‰ã€‚`))return
        if(blanket.length||notDefault.length){
            let text='è¯·ç€é‡æ£€æŸ¥ä»¥ä¸‹ä¿¡æ¯å¹¶å†æ¬¡ç¡®è®¤ï¼š'
            if(blanket.length)text+=`\nä»¥ä¸‹ç©å®¶æ²¡æœ‰æˆç»©ï¼Œå°†è¢«è®°ä¸º0åˆ†ï¼š${blanket.join('ã€')}ã€‚`
            if(notDefault.length)text+=`\nä»¥ä¸‹ç©å®¶æˆç»©è¢«æ‰‹åŠ¨ä¿®æ”¹ï¼Œä¸è‡ªåŠ¨è·å–åˆ°çš„ä¸åŒï¼š${notDefault.join('ã€')}ã€‚`
            if(!confirm(text))return
        }

        const result={}
        const resultSort=[]
        {
            let sum=0

            for(let x of RemainingPlayer){
                result[x]={
                    round:Progress.round+1,
                    game:Progress.game+1,
                    score:Number(PlayerDom[x].mainScore.textContent),
                    award:Boolean(PlayerDom[x].mainScore.dataset.award),
                    rscore:Number(PlayerDom[x].mainInputS.value),
                    mods:PlayerDom[x].mainInputM.value,
                }
                sum+=result[x].score
                resultSort.push(result[x])
            }

            const avg=sum/RemainingPlayer.length
            sum=0
            for(let x in result)
                sum+=(result[x].score-avg)**2
            
            const recStd=sum?((RemainingPlayer.length/sum)**0.5):1
            for(let x in result)
                result[x].zscore=(result[x].score-avg)*recStd
        }

        resultSort.sort((x,y)=>{return y.score-x.score})
        {
            let i = 0
            while (i < resultSort.length) {
                let j = i
                while(j + 1 < resultSort.length && resultSort[j + 1].score == resultSort[i].score) j++
                
                const avgRank = (i+j)/2 +1
                for(let k = i; k <= j; k++) resultSort[k].rank = avgRank
                
                i = j + 1
            }
        }
        
        for(let i in resultSort){
            resultSort[i].points=Config.pointsFunction(resultSort[i].rank,RemainingPlayer.length)
        }
        for(let x of RemainingPlayer){
            MatchResult[x].score.push(result[x])
            const td=document.createElement('td')
            td.className='game_points'
            td.textContent=`${result[x].rank}`
            td.title=`${Progress.round+1}-${Progress.game+1} ${x}
æˆç»©ï¼š${result[x].score}
æ’åï¼š${result[x].rank}
ç§¯åˆ†ï¼š${result[x].points/Config.constCoef}

æˆç»©è¯¦æƒ…
Zåˆ†æ•°ï¼š${result[x].zscore}
åŸå§‹åˆ†æ•°ï¼š${result[x].rscore}
Modsï¼š${result[x].mods}
å¥–åŠ±ï¼š${result[x].award?'æ˜¯':'å¦'}`
            PlayerDom[x].score.appendChild(td)
        }
        {
            const td=document.createElement('td')
            td.className='game_points'
            td.textContent=`${Progress.round+1}-${Progress.game+1}`
            td.title=`${StageG.map.bid} ï¼ˆ${StageG.map.username||('å›ºå®šå›¾'+StageG.map.host)}ï¼‰\nModsï¼š${StageG.map.mod}\nå¥–åŠ±ï¼š${StageG.map.award}`
            scoreboardHeader.appendChild(td)
        }
        {
            MatchOrder.push({round:Progress.round+1,game:Progress.game+1,map:StageG.map})
            const changingRemainingBeatmap=StageG.map.username?RemainingBeatmap.player:RemainingBeatmap.host
            for(let i=0;i<changingRemainingBeatmap.length;i++){
                if(changingRemainingBeatmap[i]==StageG.map){
                    changingRemainingBeatmap.splice(i, 1)
                    break
                }
            }
        }

        Progress.next()
    },
}
const StageE={
    init:function(){
        clearElement(mainTable)
        clearElement(mainConsole)
        clearElement(mainTableBanner)
        mainTableBanner.innerHTML=`è¯·é€‰æ‹©æœ¬è½®è¦æ·˜æ±°çš„é€‰æ‰‹ï¼š<div style="float:right;padding-right:1px;">
    <button class="yellow" onclick="StageE.refresh()">é‡ç½®é€‰æ‹©</button>
</div>`
        StageE.cmd.part0=[
            `ç¬¬${Progress.round+1}/${Order.length}è½®å·²ç»“æŸï¼Œç°åœ¨è¿›å…¥ç»“ç®—é˜¶æ®µã€‚`+
            (order.playerEnd?
                `å½“å‰å­˜æ´»${order.playerStart}åç©å®¶ï¼Œç°åœ¨éœ€è¦æ·˜æ±°${order.playerStart-order.playerEnd}åç©å®¶ã€‚`:
                `æœ¬è½®æ˜¯æœ€ç»ˆè½®ï¼ŒæŒ‰ç…§å½“å‰çš„æˆç»©ç¡®å®šåæ¬¡ã€‚`
            )
        ]
        StageE.default.length=0
        let optionHtml=''
        for(let x of RemainingPlayer){
            optionHtml+=`<option value="${x}">${x}</option>`
        }
        for(let i=(Order[Progress.round].playerEnd||0)+1;i<=RemainingPlayer.length;i++){
            const tr=document.createElement('tr')
            tr.innerHTML=`<td class="eliminateRank">ç¬¬${i}åï¼š</td>
<td class="eliminateSelect"><select onchange="StageE.changePlayer(${i},this)">${optionHtml}</select></td>`
            mainTable.appendChild(tr)
            StageE.default[i]={element:tr.querySelector('select'),value:MatchResultRank[i-1].username}
        }
        StageE.refresh()
        StageE.cmd.refresh()
        mainConsole.innerHTML=order.playerEnd?
`<div>æœ¬è½®è¦æ·˜æ±°çš„é€‰æ‰‹æœ‰${RemainingPlayer.length-Order[Progress.round].playerEnd}ä½ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨é€‰ä¸­åˆ†æ•°å½“å‰å­˜æ´»é€‰æ‰‹ä¸­ç§¯åˆ†æœ€ä½å‡ ä½ï¼Œä½†å¦‚æœæœ‰é€‰æ‰‹ä¸»åŠ¨è¦æ±‚ç¦»åœºï¼Œä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ›´æ”¹ã€‚</div>
<div>å»ºè®®äººå·¥æ£€æŸ¥ä¸€ä¸‹æ·˜æ±°é€‰æ‰‹åŠåæ¬¡æ˜¯å¦æ­£ç¡®ï¼Œç‰¹åˆ«æ˜¯ç§¯åˆ†å‡ºç°å¹¶åˆ—æƒ…å†µæ—¶ã€‚</div>`:
`<div>æœ¬è½®æ˜¯æœ€ç»ˆè½®ï¼Œç¡®å®šå…¨éƒ¨å‰©ä½™åæ¬¡ã€‚å»ºè®®äººå·¥æ£€æŸ¥ä¸€ä¸‹å…¨éƒ¨åæ¬¡æ˜¯å¦æ­£ç¡®ï¼Œç‰¹åˆ«æ˜¯ç§¯åˆ†å‡ºç°å¹¶åˆ—æƒ…å†µæ—¶ã€‚</div>
<div>æ¯”èµ›ç»“æŸåè¯·ç«‹å³æ‰“å¼€ç›´æ’­å±•ç¤ºé¡µé¢ï¼ˆç‚¹å‡»å·¦ä¾§ç¬¬å››ä¸ªæŒ‰é’®ï¼‰ï¼Œå¹¶åœ¨ç›´æ’­å±•ç¤ºé¡µé¢ç‚¹å‡»ctrl+sä»¥ä¿å­˜æœ€ç»ˆç»“æœï¼ˆä¸€å®šè¦ä½¿ç”¨å¿«æ·é”®ï¼Œå’Œå³é”®ä¿å­˜ç½‘é¡µæœ‰æ‰€åŒºåˆ«ï¼›æ­£ç¡®çš„æ•ˆæœåº”è¯¥ç­‰åŒäºä¸‹è½½ï¼Œä¸‹è½½è·å¾—çš„æ˜¯å•htmlæ–‡ä»¶ï¼‰ã€‚</div>
<div style="color: #aaa;">é€šå¸¸æ¥è¯´æœ€ç»ˆåæ¬¡ä¸éœ€è¦æ‰‹åŠ¨æ›´æ”¹ï¼ˆä¸ä¼šå› ä¸ºæœ‰äººç¦»åœºè€Œå‰¥å¤ºå…¶åæ¬¡ï¼‰ï¼Œå¦‚æœçœŸçš„å‡ºç°è¿™ç§æƒ…å†µï¼Œå¯¼è‡´ä¸Šè¿°ä¿å­˜çš„é¡µé¢åæ¬¡é”™è¯¯ï¼Œè¯·è”ç³»è£åˆ¤è¡¨ä½œè€…ã€‚</div>`
    },
    default:[],
    refresh:function(){
        for(let i in StageE.default)
            if(StageE.default[i])StageE.changePlayer(i,StageE.default[i].element,StageE.default[i].value)
    },
    changePlayer:function(i,element,value=null){
        if(value)element.value=value
        if(StageE.default[i].value==element.value) element.classList.remove('warning')
        else element.classList.add('warning')
    },
    cmd:{
        part0:[],
        refresh:function(){
            let cmd=StageE.cmd.part0
            if(order.playerEnd){
                const {eliminate}=StageE.getEliminate()
                cmd=cmd.concat([
                    `æœ¬è½®è¢«æ·˜æ±°çš„é€‰æ‰‹ä¸ºï¼š${eliminate.join('ã€')}ï¼Œç¥ä»–ä»¬ä¸‹æ¬¡å¥½è¿ã€‚`,
                ])
            }else{
                cmd=cmd.concat([
                    `æ­å–œé€‰æ‰‹${StageE.default[1].element.value}è·å¾—æœ¬åœºæ¯”èµ›çš„å† å†›ï¼Œä¹Ÿæ„Ÿè°¢å…¶ä»–æ‰€æœ‰å‚ä¸çš„é€‰æ‰‹ã€‚`,
                ])
            }
            writeCMD(cmd)
        },
    },
    getEliminate:function(){
        let flag=false
        const has=new Set()
        const eliminate=[]
        const notDefault=[]
        for(let x of StageE.default)if(x){
            const value=x.element.value
            if(has.has(value))flag=true
            else has.add(value)
            eliminate.push(value)
            if(x.value!=value)notDefault.push(value)
        }
        return {eliminate,notDefault,flag}
    },
    nextStage:function(){
        if(!order.playerEnd){
            alert('å·²ç»ç»“æŸå˜!')
            return
        }
        const {eliminate,notDefault,flag}=StageE.getEliminate()
        if(flag){
            alert('ä½ é€‰æ‹©äº†é‡å¤çš„è¢«æ·˜æ±°ç©å®¶ï¼Œè¯·å…ˆæ›´æ­£ã€‚')
            return
        }
        if(!confirm(`ä½ ç¡®å®šè¦è¿›å…¥ä¸‹é˜¶æ®µå—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚\næœ¬è½®æ·˜æ±°çš„é€‰æ‰‹ä¸º${eliminate.join('ã€')}`))return
        if(notDefault.length&&!confirm(`ä»¥ä¸‹é€‰æ‰‹ä¸ç³»ç»Ÿè‡ªåŠ¨é€‰ä¸­çš„é¡ºåºä¸ä¸€è‡´ï¼Œè¯·å†æ¬¡ç¡®è®¤ï¼š\n${notDefault.join('ã€')}`))return

        for(let i in StageE.default){
            const x=MatchResult[StageE.default[i].element.value]
            x.rank=i
            x.alive=false
            PlayerDom[StageE.default[i].element.value].score.querySelector('.username').classList.add('eliminate')
            PlayerDom[StageE.default[i].element.value].score.querySelector('.rank').classList.add('eliminate')
        }
        reRank()
        for(let x of RemainingPlayer){
            const result={
                round:Progress.round+1,
                points:MatchResult[x].currentPoints,
                rank:MatchResult[x].rank,
                eliminate:!MatchResult[x].alive
            }
            MatchResult[x].points.push(result)
            MatchResult[x].score.push(result)
            const td=document.createElement('td')
            td.className='points'
            td.innerHTML=`${format(result.points/Config.constCoef,0,Config.pointsDecimals)}`
            td.title=`${result.points/Config.constCoef}`
            PlayerDom[x].score.appendChild(td)
        }
        {
            const td=document.createElement('td')
            td.className='points'
            td.innerHTML=`ç¬¬${Progress.round+1}è½®`
            scoreboardHeader.appendChild(td)
        }
        RemainingPlayer.length=0
        for(let x in MatchResult){
            if(MatchResult[x].alive)RemainingPlayer.push(x)
        }
        MatchOrder.push({round:Progress.round+1})

        Progress.next()
    },
}

let currentStage=StageP
StageP.refresh()
const ModsNumDict={
    EZ: 2,
    HD: 8,
    HR: 16,
    SD: 32,
    DT: 64,
    HT: 256,
    FL: 1024,
}

// å·¥å…·
function format(x,digit=0,decimals=0,addition=''){
    if(addition=='%')x*=100
    x=Math.round((x * (10 ** decimals)) + 1e-10)
    let flag=false
    if(x<0){
        x=-x
        flag=true
    }
    x=x.toString()
    if(decimals&&x.length<=decimals)x='0'.repeat(decimals+1-x.length)+x
    if(flag)x='-'+x
    if(x.length<digit)x=' '.repeat(digit-x.length)+x
    if(decimals)x=x.slice(0, x.length - decimals) + '.' + x.slice(x.length - decimals)
    return x+addition
}
</script>
</body>
</html>
